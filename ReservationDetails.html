<html>
  <head>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Manrope%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    />

    <title>Stitch Design - Reservation Details</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
        /* General button styling for consistency */
        .action-button { 
            background-color: #007BFF; /* Primary action color */
            color: white; 
            padding: 8px 12px; 
            border-radius: 6px; 
            cursor: pointer; 
            transition: background-color 0.2s; 
            text-align: center; /* Ensure text is centered */
            font-size: 0.875rem; /* text-sm */
            font-weight: bold; /* font-bold */
        }
        .action-button:hover { background-color: #0056b3; } /* Darker shade on hover */
        .action-button:disabled { background-color: #C0C0C0; color: #6C757D; cursor: not-allowed; opacity: 0.7; }
        
        /* Secondary button style, e.g., for "Manage Food/Beverage Order" */
        .secondary-action-button { background-color: #6C757D; }
        .secondary-action-button:hover { background-color: #5a6268; }
    </style>
  </head>
  <body>
    <div
      class="relative flex size-full min-h-screen flex-col bg-[#F8F9FA] dark justify-between group/design-root overflow-x-hidden"
      style='font-family: Manrope, "Noto Sans", sans-serif;'
    >
      {/* Main content area, with padding at the bottom to avoid overlap with fixed action buttons bar */}
      <div class="pb-24"> {/* Increased padding for taller fixed bar */}
        {/* Sticky header for page title and back navigation */}
        <div class="flex items-center bg-[#F8F9FA] p-4 pb-2 justify-between sticky top-0 z-10 border-b border-[#DEE2E6]">
          <a href="Reservation" class="text-[#212529] flex size-12 shrink-0 items-center" data-icon="ArrowLeft" data-size="24px" data-weight="regular" aria-label="Back to Reservations">
            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
              <path d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z"></path>
            </svg>
          </a>
          <h2 class="text-[#212529] text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center pr-12">Reservation Details</h2>
        </div>
        
        {/* Section for displaying reservation details */}
        <div id="reservation-details-content">
            <h3 class="text-[#212529] text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Reservation</h3>
            <div class="bg-[#FFFFFF] px-4 py-2 border border-[#DEE2E6] rounded-lg my-2 mx-4">
                <p id="details-customer-name" class="text-[#212529] text-xl font-semibold leading-normal line-clamp-1">Caricamento...</p>
            </div>
            <div class="flex items-center gap-4 bg-[#FFFFFF] px-4 min-h-[72px] py-2 border border-[#DEE2E6] rounded-lg my-2 mx-4">
              <div class="flex flex-col justify-center">
                <p id="details-num-guests" class="text-[#212529] text-base font-medium leading-normal line-clamp-1">Ospiti: Caricamento...</p>
                <p id="details-table-number" class="text-[#6C757D] text-sm font-normal leading-normal line-clamp-2">Tavolo: Caricamento...</p>
              </div>
            </div>
            <div class="flex items-center gap-4 bg-[#FFFFFF] px-4 min-h-[72px] py-2 border border-[#DEE2E6] rounded-lg my-2 mx-4">
              <div class="flex flex-col justify-center">
                <p id="details-date" class="text-[#212529] text-base font-medium leading-normal line-clamp-1">Data: Caricamento...</p>
                <p id="details-time" class="text-[#6C757D] text-sm font-normal leading-normal line-clamp-2">Ora: Caricamento...</p>
              </div>
            </div>
             <div class="bg-[#FFFFFF] px-4 py-2 border border-[#DEE2E6] rounded-lg my-2 mx-4">
                <p id="details-reservation-status" class="text-[#212529] text-base font-medium leading-normal">Status: Caricamento...</p>
            </div>
            {/* Element to display errors related to fetching reservation details */}
            <div id="reservation-fetch-error" class="px-4 py-2 text-[#DC3545] text-sm min-h-[20px]"></div>
        </div>

        {/* Section for displaying orders associated with the reservation */}
        <h3 class="text-[#212529] text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Orders</h3>
        <div id="orders-list-container" class="bg-[#F8F9FA] px-4 py-2">
          <p class="text-[#6C757D] text-sm">Caricamento ordini...</p>
        </div>
        {/* Element to display errors related to fetching orders */}
        <div id="orders-fetch-error" class="px-4 py-2 text-[#DC3545] text-sm min-h-[20px]"></div>
        {/* Element for feedback on actions like creating an order */}
        <div id="action-feedback" class="px-4 py-2 text-sm min-h-[20px]"></div>
        {/* Element for messages related to printing orders */}
        <div id="print-message-area" class="px-4 py-2 text-sm min-h-[20px]"></div>
      </div>

      {/* Fixed bar at the bottom for order management actions */}
      <div class="fixed bottom-0 left-0 right-0 z-10 bg-[#FFFFFF] border-t border-[#DEE2E6] pt-3 pb-3 px-4">
          <div class="flex flex-col gap-3 max-w-[480px] mx-auto">
            {/* Button to manage or create a food order */}
            <button id="manage-food-order-btn" class="action-button secondary-action-button w-full">Manage Food Order</button>
            {/* Button to manage or create a beverage order */}
            <button id="manage-beverage-order-btn" class="action-button secondary-action-button w-full">Manage Beverage Order</button>
          </div>
      </div>
    </div>
    <script>
    // This script handles fetching and displaying reservation details, including associated orders.
    // It also provides functionality to manage these orders (navigate to ManageOrder.html)
    // and print individual order tickets.
    document.addEventListener('DOMContentLoaded', () => {
        // DOM element references for displaying reservation details
        const customerNameEl = document.getElementById('details-customer-name');
        const numGuestsEl = document.getElementById('details-num-guests');
        const tableNumberEl = document.getElementById('details-table-number');
        const dateEl = document.getElementById('details-date');
        const timeEl = document.getElementById('details-time');
        const statusEl = document.getElementById('details-reservation-status');
        // DOM element references for displaying orders and messages
        const ordersListContainer = document.getElementById('orders-list-container');
        const reservationFetchErrorEl = document.getElementById('reservation-fetch-error');
        const ordersFetchErrorEl = document.getElementById('orders-fetch-error');
        const printMessageArea = document.getElementById('print-message-area');
        const actionFeedbackEl = document.getElementById('action-feedback'); // For feedback on creating orders

        // Buttons for managing orders
        const manageFoodOrderBtn = document.getElementById('manage-food-order-btn');
        const manageBeverageOrderBtn = document.getElementById('manage-beverage-order-btn');
        
        // Get reservation_id from URL query parameters
        const params = new URLSearchParams(window.location.search);
        const reservationId = params.get('id');
        
        // Store for fetched reservation data, including its orders
        let fetchedReservationData = null; 

        /**
         * @description Displays a message in a specified HTML element.
         * @param {HTMLElement} element - The HTML element where the message will be shown.
         * @param {string} message - The message text.
         * @param {boolean} [isError=true] - True for error styling (red), false for success/info (green).
         * @param {number} [duration=3000] - Time in ms to display the message. 0 for persistent.
         */
        function showMessage(element, message, isError = true, duration = 3000) {
            element.textContent = message;
            element.className = isError ? 'text-[#DC3545] py-1 text-sm min-h-[20px]' : 'text-[#28A745] py-1 text-sm min-h-[20px]';
            if (message && duration > 0) { // Only set timeout if duration is positive
                setTimeout(() => { element.textContent = ''; }, duration);
            }
        }

        // Validate if reservationId is present in the URL
        if (!reservationId) {
            const detailsContentEl = document.getElementById('reservation-details-content');
            if(detailsContentEl) detailsContentEl.innerHTML = '<p class="text-[#DC3545] text-center p-8">ID Prenotazione non trovato nella URL.</p>';
            ordersListContainer.innerHTML = ''; 
            // Disable management buttons if no reservation ID
            if(manageFoodOrderBtn) manageFoodOrderBtn.disabled = true;
            if(manageBeverageOrderBtn) manageBeverageOrderBtn.disabled = true;
            return; // Stop further execution
        }

        /**
         * @description Main function to fetch reservation details (including orders) and render the page.
         */
        async function mainFetchAndRender() {
            // Clear previous error messages and set loading states
            showMessage(reservationFetchErrorEl, '', false); // Clear any old errors
            showMessage(ordersFetchErrorEl, '', false);
            showMessage(actionFeedbackEl, '', false); // Clear previous action feedback
            ordersListContainer.innerHTML = '<p class="text-[#6C757D] text-sm">Caricamento ordini...</p>'; // Initial loading message for orders
            
            try {
                // API call to fetch reservation details (expected to include associated orders)
                const response = await fetch(\`/api/reservations/\${reservationId}\`);
                if (!response.ok) {
                    let errorMsg = \`Errore HTTP: \${response.status}\`;
                    if (response.status === 404) errorMsg = 'Prenotazione non trovata.';
                    throw new Error(errorMsg); // Throw error to be caught by catch block
                }
                fetchedReservationData = await response.json(); // Store fetched data

                // Populate reservation detail fields
                customerNameEl.textContent = fetchedReservationData.customer_name;
                numGuestsEl.textContent = \`Ospiti: \${fetchedReservationData.num_guests}\`;
                tableNumberEl.textContent = \`Tavolo: \${fetchedReservationData.table_number || 'N/A'}\`;
                statusEl.textContent = \`Status: \${fetchedReservationData.status}\`;

                // Format and display reservation date and time
                const reservationDateTime = new Date(fetchedReservationData.reservation_time);
                dateEl.textContent = \`Data: \${reservationDateTime.toLocaleDateString('it-IT', { year: 'numeric', month: 'short', day: 'numeric' })}\`;
                timeEl.textContent = \`Ora: \${reservationDateTime.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })}\`;
                
                // Render the orders associated with this reservation
                if (fetchedReservationData.orders) {
                    displayOrders(fetchedReservationData.orders);
                } else {
                    // Fallback: if backend doesn't nest orders (should ideally not be needed)
                    console.warn("Reservation data did not contain 'orders' array. Attempting fallback: GET /api/orders and filter.");
                    ordersListContainer.innerHTML = '<p class="text-[#6C757D] text-sm">Controllo ordini alternativo...</p>';
                    const allOrdersResponse = await fetch('/api/orders'); // Fetch all orders
                    if (!allOrdersResponse.ok) throw new Error(\`Cannot fetch all orders: \${allOrdersResponse.status}\`);
                    const allOrders = await allOrdersResponse.json();
                    // Filter orders for the current reservation and store them
                    fetchedReservationData.orders = allOrders.filter(order => order.reservation_id === parseInt(reservationId));
                    displayOrders(fetchedReservationData.orders); // Display the filtered orders
                }
            } catch (error) {
                // Handle errors from fetching reservation details
                console.error('Errore nel caricare i dettagli della prenotazione:', error);
                if(customerNameEl) customerNameEl.textContent = ''; // Clear placeholder text
                showMessage(reservationFetchErrorEl, error.message, true, 0); // Show persistent error
                // Clear other detail fields on error
                if(numGuestsEl) numGuestsEl.textContent = ''; 
                if(tableNumberEl) tableNumberEl.textContent = ''; 
                if(dateEl) dateEl.textContent = ''; 
                if(timeEl) timeEl.textContent = ''; 
                if(statusEl) statusEl.textContent = '';
                ordersListContainer.innerHTML = ''; // Clear orders section
                // Disable management buttons on error
                if(manageFoodOrderBtn) manageFoodOrderBtn.disabled = true; 
                if(manageBeverageOrderBtn) manageBeverageOrderBtn.disabled = true;
            }
        }

        /**
         * @description Renders the list of orders for the current reservation.
         * @param {Array<object>} orders - An array of order objects.
         */
        function displayOrders(orders) {
            ordersListContainer.innerHTML = ''; // Clear previous content (e.g., "Loading orders...")
            showMessage(ordersFetchErrorEl,'',false); // Clear any previous order fetch errors

            if (!orders || orders.length === 0) {
                ordersListContainer.innerHTML = '<p class="text-[#6C757D] text-sm">Nessun ordine per questa prenotazione.</p>';
                return;
            }

            // Create and append an element for each order
            orders.forEach(order => {
                const orderDiv = document.createElement('div');
                orderDiv.className = 'mb-4 p-3 rounded-lg bg-[#FFFFFF] border border-[#DEE2E6]'; // Styling for each order card
                
                // Determine display title based on order_type
                const orderTypeTitle = order.order_type === 'food' ? 'Ordine Cibo' : 
                                      order.order_type === 'beverage' ? 'Ordine Bevande' : 'Ordine';
                // Calculate item count (assuming 'items' array is present on order objects)
                const itemCount = order.items ? order.items.length : 0;
                
                // Populate the order card's HTML
                orderDiv.innerHTML = \`
                  <p class="text-[#212529] font-semibold">\${orderTypeTitle} (ID: \${order.id})</p>
                  <p class="text-sm text-[#6C757D]">Articoli: \${itemCount}</p>
                  <p class="text-sm text-[#6C757D]">Status: \${order.status}</p>
                  <button data-order-id="\${order.id}" class="print-order-btn mt-2 px-3 py-1 bg-[#007BFF] text-white text-xs font-bold rounded hover:bg-[#0056b3] transition-colors">Stampa</button>
                  <span class="print-status text-xs ml-2 min-h-[16px] inline-block"></span>
                \`;
                ordersListContainer.appendChild(orderDiv);
            });

            // Add event listeners to all "Print" buttons
            document.querySelectorAll('.print-order-btn').forEach(button => {
                button.addEventListener('click', handlePrintOrder);
            });
        }

        /**
         * @description Handles the click event for "Manage Food/Beverage Order" buttons.
         *              Either navigates to an existing order or creates a new one.
         * @param {string} orderType - The type of order to manage ('food' or 'beverage').
         */
        async function handleManageOrder(orderType) {
            // Display processing message and disable buttons to prevent multiple clicks
            showMessage(actionFeedbackEl, \`Processing \${orderType} order...\`, false, 0);
            if(manageFoodOrderBtn) manageFoodOrderBtn.disabled = true; 
            if(manageBeverageOrderBtn) manageBeverageOrderBtn.disabled = true;

            let orderToManage = null;
            // Check if an order of the specified type already exists for this reservation
            if (fetchedReservationData && fetchedReservationData.orders) {
                orderToManage = fetchedReservationData.orders.find(o => o.order_type === orderType);
            }

            if (orderToManage) {
                // If order exists, navigate to ManageOrder.html with reservation and order IDs
                window.location.href = \`ManageOrder.html?reservation_id=\${reservationId}&order_id=\${orderToManage.id}\`;
            } else {
                // If order does not exist, create a new one
                try {
                    // API call to create a new order
                    const response = await fetch(\`/api/reservations/\${reservationId}/orders\`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ order_type: orderType }) // Payload specifies the order type
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || \`Failed to create \${orderType} order\`);
                    }
                    const newOrder = await response.json(); // Get the newly created order details
                    
                    // Re-fetch all reservation details to update the UI, including the new order.
                    await mainFetchAndRender(); 
                    showMessage(actionFeedbackEl, \`\${orderType.charAt(0).toUpperCase() + orderType.slice(1)} order created. Redirecting...\`, false, 2000);
                    // Navigate to ManageOrder.html for the new order after a short delay
                    setTimeout(() => {
                        window.location.href = \`ManageOrder.html?reservation_id=\${reservationId}&order_id=\${newOrder.id}\`;
                    }, 500); 
                } catch (error) {
                    // Handle errors during order creation
                    showMessage(actionFeedbackEl, error.message, true, 0);
                    // Re-enable buttons if creation failed before navigation
                    if(manageFoodOrderBtn) manageFoodOrderBtn.disabled = false; 
                    if(manageBeverageOrderBtn) manageBeverageOrderBtn.disabled = false;
                }
            }
             // Re-enable buttons if navigation didn't occur (e.g. error before redirect in creation path)
             // This timeout helps ensure buttons are re-enabled if user cancels navigation or if an error stops it.
            setTimeout(() => {
                 if (!window.location.href.includes("ManageOrder.html")) { 
                    if(manageFoodOrderBtn) manageFoodOrderBtn.disabled = false; 
                    if(manageBeverageOrderBtn) manageBeverageOrderBtn.disabled = false;
                 }
            }, 1000);
        }

        // Attach event listeners to the "Manage Order" buttons
        if(manageFoodOrderBtn) manageFoodOrderBtn.addEventListener('click', () => handleManageOrder('food'));
        if(manageBeverageOrderBtn) manageBeverageOrderBtn.addEventListener('click', () => handleManageOrder('beverage'));

        /**
         * @description Handles the click event for "Print" buttons on individual orders.
         * @param {Event} event - The click event.
         */
        async function handlePrintOrder(event) {
            const orderId = event.target.dataset.orderId; // Get order_id from data attribute
            const printStatusEl = event.target.nextElementSibling; // Span for inline print status

            showMessage(printMessageArea, '', false); // Clear any global print messages
            if(printStatusEl) {
                printStatusEl.textContent = 'Stampa in corso...'; // "Printing..."
                printStatusEl.className = 'text-xs ml-2 text-yellow-400';
            }

            try {
                // API call to get printable HTML for the order
                const response = await fetch(\`/api/orders/\${orderId}/print\`);
                if (!response.ok) {
                    // Try to parse error if JSON, otherwise use statusText
                    let errorDetail = response.statusText;
                    try {
                        const errorData = await response.json();
                        if(errorData && errorData.error) errorDetail = errorData.error;
                        if(errorData && errorData.message) errorDetail = errorData.message; // For cases like "No items found"
                    } catch (e) { /* Ignore if not JSON */ }
                    throw new Error(\`Print error: \${response.status} - \${errorDetail}\`);
                }
                
                // Check if response is HTML or JSON (for "no items" message)
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    const jsonData = await response.json();
                    showMessage(printMessageArea, jsonData.message || "No items to print for this order type.", false);
                     if(printStatusEl) {
                        printStatusEl.textContent = 'Nothing to print.';
                        printStatusEl.className = 'text-xs ml-2 text-gray-400';
                     }
                    return;
                }

                const htmlContent = await response.text(); // Get HTML content as text
                
                // Open a new window and write the HTML content into it
                const printWindow = window.open('', '_blank');
                if (printWindow) {
                    printWindow.document.write(htmlContent);
                    printWindow.document.close(); // Important for the page to render properly
                    // printWindow.print(); // Optional: automatically trigger the browser's print dialog
                    if(printStatusEl) {
                        printStatusEl.textContent = 'Completato.'; // "Completed."
                        printStatusEl.className = 'text-xs ml-2 text-green-400';
                    }
                } else {
                    // Handle popup blocker
                    alert('Impossibile aprire la finestra di stampa. Controlla le impostazioni del popup blocker.');
                    showMessage(printMessageArea, 'Popup blocker may have prevented opening the print window.', true, 0);
                    if(printStatusEl) {
                        printStatusEl.textContent = 'Fallito.'; // "Failed."
                        printStatusEl.className = 'text-xs ml-2 text-red-400';
                    }
                }
            } catch (error) {
                // Handle errors during printing
                console.error('Print error:', error);
                alert(\`Errore stampa: \${error.message}\`); // Alert for critical errors
                showMessage(printMessageArea, \`Print error for order \${orderId}: \${error.message}\`, true, 0);
                if(printStatusEl) {
                    printStatusEl.textContent = 'Fallito.';
                    printStatusEl.className = 'text-xs ml-2 text-red-400';
                }
            }
        }
        
        // Initial data fetch when the page loads
        mainFetchAndRender();

        // Event listener to re-fetch data if the page is loaded from browser cache (e.g., via back button)
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                console.log('Page loaded from bfcache. Re-fetching details.');
                mainFetchAndRender(); // Re-run the main fetch and render logic
            }
        });
    });
    </script>
  </body>
</html>
