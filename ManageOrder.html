<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Order</title>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Manrope%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
        body { font-family: Manrope, "Noto Sans", sans-serif; }
        .menu-item-card { background-color: #FFFFFF; border: 1px solid #DEE2E6; color: #212529; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .current-order-item-card { background-color: #FFFFFF; border: 1px solid #DEE2E6; color: #212529; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .action-button { background-color: #007BFF; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; }
        .action-button:hover { background-color: #0056b3; }
        .action-button:disabled { background-color: #C0C0C0; color: #6C757D; cursor: not-allowed; opacity: 0.7; }
        .remove-button { background-color: #DC3545; } /* Tailwind red-500 */
        .remove-button:hover { background-color: #C82333; } /* Tailwind red-600 */
        .quantity-controls button { background-color: #007BFF; /* Tailwind violet-500 */ padding: 4px 8px; border-radius: 4px; }
        .quantity-controls input { width: 40px; text-align: center; background-color: #FFFFFF; border: 1px solid #DEE2E6; border-radius:4px; margin: 0 4px; color: #212529; } /* Added color: white for input text */
        .special-requests-input { background-color: #FFFFFF; border: 1px solid #DEE2E6; color:#212529; padding: 6px; border-radius: 4px; width: calc(100% - 80px); margin-right:5px; } /* Adjusted width */
        .save-request-btn { background-color: #007BFF; /* Tailwind emerald-500 */ padding: 4px 8px; text-xs; border-radius:4px;}
    </style>
</head>
<body class="bg-[#F8F9FA] text-[#212529]">

    {/* Header section: Title and Back button */}
    <header class="p-4 bg-[#FFFFFF] sticky top-0 z-10 border-b border-[#DEE2E6]">
        <div class="flex justify-between items-center">
            <h2 id="manage-order-title" class="text-xl font-bold">Manage Order</h2>
            <a id="back-to-reservation-btn" href="#" class="action-button text-sm">Back to Reservation</a>
        </div>
        {/* Divs for displaying general errors or action feedback messages */}
        <div id="error-message" class="text-[#DC3545] mt-2 text-sm min-h-[20px]"></div>
        <div id="action-feedback" class="mt-2 text-sm min-h-[20px]"></div> {/* Class for color set by showMessage */}
    </header>

    {/* Main content area: two-column layout for menu items and current order */}
    <div class="flex flex-col md:flex-row gap-4 p-4">
        {/* Left Column: Menu Items */}
        <div class="md:w-1/2">
            <h3 class="text-lg font-semibold mb-2">Menu Items</h3>
            {/* Container for menu items, scrollable */}
            <div id="menu-items-container" class="space-y-2 max-h-[70vh] overflow-y-auto p-2 bg-[#E9ECEF] rounded-md">
                <p class="text-[#6C757D]">Loading menu items...</p> {/* Initial loading message */}
            </div>
        </div>

        {/* Right Column: Current Order Items */}
        <div class="md:w-1/2">
            <h3 class="text-lg font-semibold mb-2">Current Order</h3>
            {/* Container for current order items, scrollable */}
            <div id="current-order-items-container" class="space-y-2 max-h-[70vh] overflow-y-auto p-2 bg-[#E9ECEF] rounded-md">
                <p class="text-[#6C757D]">Loading order items...</p> {/* Initial loading message */}
            </div>
            {/* Section to display the total price of the order */}
            <div class="mt-4 p-3 bg-[#FFFFFF] rounded-md border border-[#DEE2E6]">
                <h4 class="text-lg font-semibold">Order Total: <span id="order-total">$0.00</span></h4>
            </div>
        </div>
    </div>

    <script>
    // This script manages the order editing page, allowing users to add, remove,
    // and update items in an order, and view the order total.
    document.addEventListener('DOMContentLoaded', () => {
        // DOM element references
        const manageOrderTitle = document.getElementById('manage-order-title');
        const errorMessageDiv = document.getElementById('error-message'); // For critical page errors
        const actionFeedbackDiv = document.getElementById('action-feedback'); // For feedback on item actions
        const menuItemsContainer = document.getElementById('menu-items-container');
        const currentOrderItemsContainer = document.getElementById('current-order-items-container');
        const backToReservationBtn = document.getElementById('back-to-reservation-btn');
        const orderTotalEl = document.getElementById('order-total');

        // Page state variables
        let currentOrder = null; // Stores the current order object being managed
        let currentReservationId = null; // From URL query param
        let currentOrderId = null;       // From URL query param

        /**
         * @description Displays a message in a specified HTML element, styled for error or success.
         * @param {HTMLElement} element - The HTML element where the message will be shown.
         * @param {string} message - The message text to display.
         * @param {boolean} [isError=true] - If true, styles as an error message; otherwise, as a success/info message.
         * @param {number} [duration=3000] - Time in ms to display the message. 0 for persistent.
         */
        function showMessage(element, message, isError = true, duration = 3000) {
            element.textContent = message;
            // Apply appropriate Tailwind CSS classes based on message type
            element.className = isError ? 'text-[#DC3545] py-1 text-sm min-h-[20px]' : 'text-[#28A745] py-1 text-sm min-h-[20px]';
            if (message && duration > 0) { // Only set timeout if duration is positive and message exists
                setTimeout(() => { element.textContent = ''; }, duration);
            }
        }
        
        // Get reservation_id and order_id from URL query parameters
        const params = new URLSearchParams(window.location.search);
        currentReservationId = params.get('reservation_id');
        currentOrderId = params.get('order_id');

        // Validate presence of required URL parameters
        if (!currentReservationId || !currentOrderId) {
            showMessage(errorMessageDiv, 'Reservation ID or Order ID missing from URL.', true, 0); // Persistent error
            manageOrderTitle.textContent = 'Error';
            // Clear loading messages from containers
            if(menuItemsContainer) menuItemsContainer.innerHTML = '<p class="text-[#DC3545]">Cannot load page.</p>'; 
            if(currentOrderItemsContainer) currentOrderItemsContainer.innerHTML = '<p class="text-[#DC3545]">Cannot load page.</p>';
            return; // Stop further execution
        }
        // Set the href for the "Back to Reservation" button
        backToReservationBtn.href = \`ReservationDetails.html?id=\${currentReservationId}\`;

        /**
         * @description Finds an order item within the currentOrder.items array by its menu_item_id.
         * @param {number} menuItemId - The ID of the menu item to find.
         * @returns {object|null} The found order item object or null if not found.
         */
        function findOrderItemByMenuItemId(menuItemId) {
            if (!currentOrder || !currentOrder.items) return null;
            return currentOrder.items.find(item => item.menu_item_id === menuItemId);
        }

        /**
         * @description Fetches the full order details from the API and triggers UI updates.
         * @param {boolean} [showActionFeedback=false] - If true, shows a generic "Order updated" message.
         */
        async function fetchOrderDetails(showActionFeedback = false) {
            try {
                // API call to get the specified order
                const response = await fetch(\`/api/orders/\${currentOrderId}\`);
                if (!response.ok) {
                    const errorData = await response.json(); // Attempt to get error details from API
                    throw new Error(errorData.error || \`HTTP Error: \${response.status}\`);
                }
                currentOrder = await response.json(); // Store the fetched order data

                // Update page title with order type and ID
                manageOrderTitle.textContent = \`Manage \${currentOrder.order_type === 'food' ? 'Food' : 'Beverage'} Order (ID: \${currentOrder.id})\`;
                
                // Render the items currently in the order
                renderCurrentOrderItems(currentOrder.items);
                // Calculate and display the total price of the order
                calculateAndDisplayTotal(currentOrder.items);

                if (showActionFeedback) {
                    showMessage(actionFeedbackDiv, 'Order updated successfully.', false);
                }

                // Fetch and render menu items only if not already loaded (e.g., on initial page load)
                // This checks if the menu container still has its "Loading..." placeholder.
                if (menuItemsContainer.querySelector('p.text-[#6C757D]')) { 
                    await fetchAndRenderMenuItems(currentOrder.order_type);
                }
            } catch (error) {
                console.error('Failed to fetch order details:', error);
                showMessage(errorMessageDiv, \`Failed to load order details: \${error.message}\`, true, 0);
                if(currentOrderItemsContainer) currentOrderItemsContainer.innerHTML = '<p class="text-[#DC3545]">Could not load order items.</p>'; 
            }
        }

        /**
         * @description Fetches menu items from the API, filters them by order type, and renders them.
         * @param {string} orderType - The type of order ('food' or 'beverage') to filter menu items for.
         */
        async function fetchAndRenderMenuItems(orderType) {
            menuItemsContainer.innerHTML = '<p class="text-[#6C757D]">Loading menu items...</p>';
            try {
                // API call to get all menu items
                const response = await fetch('/api/menu_items');
                if (!response.ok) throw new Error(\`HTTP Error fetching menu: \${response.status}\`);
                const allMenuItems = await response.json();
                
                // Define categories considered as beverages for filtering
                const beverageCategories = ['beverage', 'drinks', 'wine', 'cocktails', 'beer', 'soft drink'];
                let filteredMenuItems;

                // Filter menu items based on the order type
                if (orderType === 'food') {
                    filteredMenuItems = allMenuItems.filter(item => !beverageCategories.includes(item.category.toLowerCase()));
                } else if (orderType === 'beverage') {
                    filteredMenuItems = allMenuItems.filter(item => beverageCategories.includes(item.category.toLowerCase()));
                } else { 
                    // Should not happen if order_type is always 'food' or 'beverage'
                    console.warn(\`Unknown order type for menu filtering: \${orderType}\`);
                    filteredMenuItems = allMenuItems; 
                }
                renderMenuItems(filteredMenuItems); // Render the filtered menu items
            } catch (error) {
                console.error('Failed to fetch menu items:', error);
                showMessage(errorMessageDiv, \`Failed to load menu: \${error.message}\`, true, 0);
                if(menuItemsContainer) menuItemsContainer.innerHTML = '<p class="text-[#DC3545]">Could not load menu items.</p>';
            }
        }

        /**
         * @description Renders the list of available menu items in the UI.
         * @param {Array<object>} menuItems - Array of menu item objects to render.
         */
        function renderMenuItems(menuItems) {
            menuItemsContainer.innerHTML = ''; // Clear previous content
            if (!menuItems || menuItems.length === 0) {
                menuItemsContainer.innerHTML = '<p class="text-[#6C757D]">No menu items available for this order type.</p>';
                return;
            }
            // Create and append an element for each menu item
            menuItems.forEach(menuItem => {
                const card = document.createElement('div');
                card.className = 'menu-item-card flex justify-between items-center';
                card.innerHTML = \`
                    <div>
                        <p class="font-semibold">\${menuItem.name}</p>
                        <p class="text-sm text-[#212529]">$ \${menuItem.price.toFixed(2)}</p>
                    </div>
                    <button data-menu-item-id="\${menuItem.id}" class="add-to-order-btn action-button text-sm">Add</button>
                \`;
                menuItemsContainer.appendChild(card);
            });
            // Add event listeners to all "Add" buttons
            document.querySelectorAll('.add-to-order-btn').forEach(button => button.addEventListener('click', handleAddToOrder));
        }
        
        /**
         * @description Renders the items currently in the order in the UI.
         * @param {Array<object>} orderItems - Array of order item objects.
         */
        function renderCurrentOrderItems(orderItems) {
            currentOrderItemsContainer.innerHTML = ''; // Clear previous content
            if (!orderItems || orderItems.length === 0) {
                currentOrderItemsContainer.innerHTML = '<p class="text-[#6C757D]">No items in this order yet.</p>';
                return;
            }
            // Create and append an element for each item in the current order
            orderItems.forEach(item => {
                const card = document.createElement('div');
                card.className = 'current-order-item-card p-3'; // Styling for the item card
                // Populate card with item details and controls
                card.innerHTML = \`
                    <p class="font-semibold text-md">\${item.menu_item_name || 'Unknown Item'}</p>
                    <p class="text-xs text-[#6C757D] mb-1">Unit Price: <span class="text-[#212529]">$ \${(item.menu_item_price || 0).toFixed(2)}</span></p>
                    {/* Quantity controls: minus button, input field, plus button */}
                    <div class="flex items-center gap-2 mb-2 quantity-controls">
                        <label class="text-xs">Qty:</label>
                        <button data-order-item-id="\${item.id}" data-change="-1" class="quantity-change-btn action-button text-xs">-</button>
                        <input type="number" min="1" value="\${item.quantity}" class="quantity-input" data-order-item-id="\${item.id}" data-current-quantity="\${item.quantity}">
                        <button data-order-item-id="\${item.id}" data-change="1" class="quantity-change-btn action-button text-xs">+</button>
                    </div>
                    {/* Special requests input and save button */}
                    <div class="flex items-center gap-2 mb-2">
                         <input type="text" data-order-item-id="\${item.id}" placeholder="Special requests..." class="special-requests-input text-xs" value="\${item.special_requests || ''}">
                         <button data-order-item-id="\${item.id}" class="save-request-btn action-button text-xs">Save Req.</button>
                    </div>
                    {/* Remove item button */}
                    <button data-order-item-id="\${item.id}" class="remove-order-item-btn action-button remove-button text-xs w-full">Remove</button>
                \`;
                currentOrderItemsContainer.appendChild(card);
            });

            // Add event listeners for new controls
            document.querySelectorAll('.quantity-change-btn').forEach(button => button.addEventListener('click', handleQuantityChangeBtn));
            document.querySelectorAll('.quantity-input').forEach(input => input.addEventListener('change', handleQuantityInputChange));
            document.querySelectorAll('.save-request-btn').forEach(button => button.addEventListener('click', handleSaveSpecialRequest));
            document.querySelectorAll('.remove-order-item-btn').forEach(button => button.addEventListener('click', handleRemoveOrderItem));
        }

        /**
         * @description Handles adding a menu item to the current order.
         *              If item exists, its quantity is incremented; otherwise, a new order item is created.
         * @param {Event} event - The click event from an "Add" button.
         */
        async function handleAddToOrder(event) {
            const menuItemId = parseInt(event.target.dataset.menuItemId);
            showMessage(actionFeedbackDiv, '', false); // Clear previous feedback
            const existingOrderItem = findOrderItemByMenuItemId(menuItemId); // Check if item is already in order

            if (existingOrderItem) {
                // Item exists, increment its quantity
                try {
                    const newQuantity = existingOrderItem.quantity + 1;
                    // API call to update the quantity of the existing order item
                    const response = await fetch(\`/api/order_items/\${existingOrderItem.id}\`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ quantity: newQuantity })
                    });
                    if (!response.ok) {
                         const errorData = await response.json();
                         throw new Error(errorData.error || 'Failed to update quantity');
                    }
                    await fetchOrderDetails(true); // Refresh order and show success message
                } catch (error) { showMessage(actionFeedbackDiv, error.message, true); }
            } else {
                // Item is new, add it to the order
                try {
                    // API call to add a new item to the order
                    const response = await fetch(\`/api/orders/\${currentOrderId}/items\`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ menu_item_id: menuItemId, quantity: 1 }) // Default quantity to 1
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to add item.');
                    }
                    await fetchOrderDetails(true); // Refresh order and show success message
                } catch (error) { showMessage(actionFeedbackDiv, error.message, true); }
            }
        }

        /**
         * @description Generic function to update an order item (quantity or special requests).
         * @param {number} orderItemId - The ID of the order item to update.
         * @param {object} payload - The data to update (e.g., { quantity: 2 } or { special_requests: "Extra cheese" }).
         * @param {string} successMessage - Message to display on successful update.
         */
        async function updateOrderItem(orderItemId, payload, successMessage) {
            try {
                // API call to update the order item
                const response = await fetch(\`/api/order_items/\${orderItemId}\`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Update failed');
                }
                // Re-fetch order details to reflect changes and ensure data consistency
                await fetchOrderDetails(false); // Pass false to avoid generic "Order updated" if specific message is better
                showMessage(actionFeedbackDiv, successMessage, false); // Show specific success message
            } catch (error) {
                showMessage(actionFeedbackDiv, error.message, true);
                // Re-fetch to revert any optimistic UI changes if the update failed
                await fetchOrderDetails(false); 
            }
        }

        /**
         * @description Handles quantity changes from +/- buttons.
         * @param {Event} event - The click event from a +/- button.
         */
        async function handleQuantityChangeBtn(event) {
            const orderItemId = event.target.dataset.orderItemId;
            const change = parseInt(event.target.dataset.change); // -1 or 1
            const inputField = event.target.parentElement.querySelector('.quantity-input');
            let newQuantity = parseInt(inputField.value) + change;
            if (newQuantity < 1) newQuantity = 1; // Quantity cannot be less than 1
            
            // No optimistic update of inputField.value here; let fetchOrderDetails handle it after successful API call.
            await updateOrderItem(orderItemId, { quantity: newQuantity }, 'Quantity updated.');
        }
        
        /**
         * @description Handles quantity changes from direct input into the number field.
         * @param {Event} event - The change event from the quantity input field.
         */
        async function handleQuantityInputChange(event) {
            const orderItemId = event.target.dataset.orderItemId;
            let newQuantity = parseInt(event.target.value);
            if (isNaN(newQuantity) || newQuantity < 1) {
                // If invalid input, revert to the last known valid quantity (or 1)
                newQuantity = parseInt(event.target.dataset.currentQuantity) || 1; 
                event.target.value = newQuantity; // Visually revert in input field
                 showMessage(actionFeedbackDiv, 'Quantity must be at least 1.', true);
                return; // Stop if quantity is invalid
            }
            // event.target.dataset.currentQuantity = newQuantity; // Update stored current quantity (done by re-render)
            await updateOrderItem(orderItemId, { quantity: newQuantity }, 'Quantity updated.');
        }

        /**
         * @description Handles saving special requests for an order item.
         * @param {Event} event - The click event from a "Save Req." button.
         */
        async function handleSaveSpecialRequest(event) {
            const orderItemId = event.target.dataset.orderItemId;
            // Find the input field relative to the clicked button
            const inputField = event.target.parentElement.querySelector('.special-requests-input');
            const specialRequests = inputField.value.trim();
            await updateOrderItem(orderItemId, { special_requests: specialRequests }, 'Special requests saved.');
        }

        /**
         * @description Handles removing an item from the order.
         * @param {Event} event - The click event from a "Remove" button.
         */
        async function handleRemoveOrderItem(event) {
            const orderItemId = event.target.dataset.orderItemId;
            // Confirm before deleting
            if (confirm('Are you sure you want to remove this item from the order?')) {
                try {
                    // API call to delete the order item
                    const response = await fetch(\`/api/order_items/\${orderItemId}\`, { method: 'DELETE' });
                    if (!response.ok) {
                         const errorData = await response.json();
                         throw new Error(errorData.error || 'Failed to remove item.');
                    }
                    await fetchOrderDetails(false); // Re-fetch order details to update UI
                    showMessage(actionFeedbackDiv, 'Item removed successfully.', false);
                } catch (error) { showMessage(actionFeedbackDiv, error.message, true); }
            }
        }
        
        /**
         * @description Calculates the total price of all items in the order and updates the UI.
         * @param {Array<object>} orderItems - Array of items in the current order.
         */
        function calculateAndDisplayTotal(orderItems) {
            if (!orderItems) { // Guard against null/undefined orderItems
                orderTotalEl.textContent = '$0.00';
                return;
            }
            // Calculate total by summing (price * quantity) for each item
            const total = orderItems.reduce((sum, item) => {
                // Ensure menu_item_price and quantity are valid numbers
                const price = parseFloat(item.menu_item_price) || 0;
                const quantity = parseInt(item.quantity) || 0;
                return sum + (price * quantity);
            }, 0);
            orderTotalEl.textContent = \`$\${total.toFixed(2)}\`; // Display formatted total
        }

        // Initial data fetch when the page loads
        fetchOrderDetails();
    });
    </script>
</body>
</html>
